@model IEnumerable<MedCenter.DTOs.TurnoViewDTO>
@using MedCenter.Services.TurnoSv
@{
    ViewData["Title"] = "Gestión de Turnos";
}

<!-- Asegurar que Font Awesome esté cargado -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4><i class="fas fa-calendar-alt me-2"></i>Gestión de Turnos</h4>
        </div>
        <div class="card-body">
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show">
                    <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show">
                    <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <div class="mb-3">
                <a asp-action="Create" class="btn btn-success">
                    <i class="fas fa-plus me-2"></i>Nuevo Turno
                </a>
            </div>

            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Paciente</th>
                                <th>Médico</th>
                                <th>Estado</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var turno in Model)
                            {
                                <tr>
                                    <td><i class="fas fa-calendar text-primary me-2"></i>@turno.Fecha</td>
                                    <td><i class="fas fa-clock text-muted me-2"></i>@turno.Hora</td>
                                    <td><i class="fas fa-user text-info me-2"></i>@turno.PacienteNombre</td>
                                    <td><i class="fas fa-user-md text-success me-2"></i>@turno.MedicoNombre</td>
                                    <td>
                                        @{
                                            var badgeClass = turno.Estado switch
                                            {
                                                "Reservado" => "bg-success",
                                                "Reprogramado" => "bg-warning text-dark",
                                                "Cancelado" => "bg-danger",
                                                "Finalizado" => "bg-primary",
                                                _ => "bg-secondary"
                                            };
                                            
                                            var icon = turno.Estado switch
                                            {
                                                "Reservado" => "fa-check",
                                                "Reprogramado" => "fa-calendar-alt",
                                                "Cancelado" => "fa-times",
                                                "Finalizado" => "fa-check-double",
                                                _ => "fa-question"
                                            };
                                        }
                                        <span class="badge @badgeClass">
                                            <i class="fas @icon me-1"></i>@turno.Estado
                                        </span>
                                        @if (turno.Estado == EstadosTurno.Reprogramado.ToString())
                                        {
                                            <small class="text-muted d-block mt-1">
                                                <i class="fas fa-info-circle"></i> No puede reprogramarse nuevamente
                                            </small>
                                        }
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <!-- Ver detalles -->
                                            <a asp-action="Details" asp-route-id="@turno.Id" 
                                               class="btn btn-outline-primary btn-sm" 
                                               title="Ver detalles">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            
                                            <!-- Reprogramar (solo si está Reservado) -->
                                            @if (turno.Estado == EstadosTurno.Reservado.ToString())
                                            {
                                                <a asp-action="Edit" asp-route-id="@turno.Id" 
                                                   class="btn btn-outline-warning btn-sm" 
                                                   title="Reprogramar">
                                                    <i class="fas fa-calendar-alt"></i>
                                                </a>
                                            }
                                            
                                            <!-- Botón deshabilitado si ya fue reprogramado -->
                                            @if (turno.Estado == EstadosTurno.Reprogramado.ToString())
                                            {
                                                <button class="btn btn-outline-secondary btn-sm" 
                                                        disabled 
                                                        title="Ya fue reprogramado">
                                                    <i class="fas fa-ban"></i>
                                                </button>
                                            }
                                            
                                            <!-- Cancelar (si está Reservado o Reprogramado) -->
                                            @if (turno.Estado == EstadosTurno.Reservado.ToString() || turno.Estado == EstadosTurno.Reprogramado.ToString())
                                            {
                                                <a asp-action="Cancel" asp-route-id="@turno.Id" 
                                                   class="btn btn-outline-danger btn-sm" 
                                                   title="Cancelar">
                                                    <i class="fas fa-times"></i>
                                                </a>
                                                
                                                <!-- Finalizar -->
                                                <form asp-action="Finalizar" asp-route-id="@turno.Id" method="post" class="d-inline">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" 
                                                            class="btn btn-outline-success btn-sm" 
                                                            title="Finalizar" 
                                                            onclick="return confirm('¿Confirmar que el paciente fue atendido?')">
                                                        <i class="fas fa-check-double"></i>
                                                    </button>
                                                </form>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No hay turnos activos en este momento.
                </div>
            }
        </div>
    </div>
</div>

<style>
    .badge {
        font-size: 0.85rem;
        padding: 0.4rem 0.6rem;
    }
    
    /* Asegurar que los botones se vean correctamente */
    .btn-outline-primary,
    .btn-outline-warning,
    .btn-outline-danger,
    .btn-outline-success,
    .btn-outline-secondary {
        border-width: 1px;
        font-weight: 500;
    }
    
    .btn-outline-primary {
        color: #0d6efd !important;
        border-color: #0d6efd !important;
    }
    
    .btn-outline-primary:hover {
        color: #fff !important;
        background-color: #0d6efd !important;
    }
    
    .btn-outline-warning {
        color: #ffc107 !important;
        border-color: #ffc107 !important;
    }
    
    .btn-outline-warning:hover {
        color: #000 !important;
        background-color: #ffc107 !important;
    }
    
    .btn-outline-danger {
        color: #dc3545 !important;
        border-color: #dc3545 !important;
    }
    
    .btn-outline-danger:hover {
        color: #fff !important;
        background-color: #dc3545 !important;
    }
    
    .btn-outline-success {
        color: #198754 !important;
        border-color: #198754 !important;
    }
    
    .btn-outline-success:hover {
        color: #fff !important;
        background-color: #198754 !important;
    }
    
    .btn-outline-secondary {
        color: #6c757d !important;
        border-color: #6c757d !important;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .btn-group-sm > .btn {
        padding: 0.375rem 0.6rem;
    }
    
    /* Asegurar que los iconos se vean */
    .btn i.fas {
        font-size: 0.875rem;
    }
</style>